#
# Copyright 2024 Wolfgang Hoschek AT mac DOT com
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This workflow will run automated unit tests and integration tests on a matrix
# of various old and new versions of ZFS/Python/Linux/FreeBSD/Solaris.
# It will also generate code coverage reports.
name: Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      name:
        description: "Name of job to run"
        type: choice
        options:
        - test_ubuntu_24_04_fast
        - test_ubuntu_24_04
        - test_ubuntu_24_04_zfs_latest
        - test_ubuntu_22_04
        - test_ubuntu_20_04
        - test_freebsd_14_1
        - test_freebsd_13_3
        - test_solaris_11_4
        default: "test_ubuntu_24_04_fast"
      run_all_jobs:
        description: Run all jobs
        type: boolean
        default: False
  schedule:
    - cron: '0 3 * * *'  # Runs daily at 3am UTC
#    - cron: '0 4 * * 0'  # Runs weekly at 4am UTC on Sundays

permissions:
  contents: read

jobs:
  test_ubuntu_24_04_fast:
    if: (!contains(github.event.head_commit.message, 'ci skip') && github.event_name != 'workflow_dispatch') || github.event.inputs.name == 'test_ubuntu_24_04_fast'
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        python-version: ["3.12"]
    timeout-minutes: 80
    steps:
    - uses: actions/checkout@v4
    - name: Run common preparation steps
      uses: ./.github/workflows/common
      with:
        python-version: ${{ matrix.python-version }}
    - name: Display ZFS version and Python version
      run: |
        id -u -n
        uname -a
        zfs --version
        python3 --version
        ssh -V
        zstd --version
        pv --version | head -n 1
        mbuffer --version |& head -n 1
        command -v sh | xargs ls -l
    - name: Test with unittest
      run: |
        ./test.sh
        echo "wbackup-zfs-testrun-success"


  test_ubuntu_24_04:
    if: github.event_name == 'schedule' || github.event.inputs.run_all_jobs == 'true' || github.event.inputs.name == 'test_ubuntu_24_04'
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        python-version: ["3.12"]
    timeout-minutes: 80
    steps:
    - uses: actions/checkout@v4
    - name: Run common preparation steps
      uses: ./.github/workflows/common
      with:
        python-version: ${{ matrix.python-version }}
    - name: Display ZFS version and Python version
      run: |
        id -u -n
        uname -a
        zfs --version
        python3 --version
        ssh -V
        zstd --version
        pv --version | head -n 1
        mbuffer --version |& head -n 1
        command -v sh | xargs ls -l
    - name: Test with unittest
      run: |
        ./test.sh
    - name: Run tests and generate code coverage
      run: |
        ./coverage.sh
        echo "wbackup-zfs-testrun-success"
    - name: Upload code coverage report to workflow run page
      uses: ./.github/workflows/coverage-upload


  test_ubuntu_24_04_zfs_latest:
    if: github.event_name == 'schedule' || github.event.inputs.run_all_jobs == 'true' || github.event.inputs.name == 'test_ubuntu_24_04_zfs_latest'
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        python-version: ["3.13-dev", "3.11"]
    timeout-minutes: 80
    steps:
    - uses: actions/checkout@v4
    - name: Upgrade zfs kernel + userland to specific upstream zfs version
      run: |
        # see https://launchpad.net/~satadru-umich/+archive/ubuntu/zfs-experimental/+packages
        sudo add-apt-repository ppa:satadru-umich/zfs-experimental; sudo apt update 
        # sudo apt-get -y apt install zfs-dkms=2.2.5~rc7-noble1 zfsutils-linux
        sudo apt-get -y install zfs-dkms zfsutils-linux
        zfs --version
    - name: Run common preparation steps
      uses: ./.github/workflows/common
      with:
        python-version: ${{ matrix.python-version }}
    - name: Display ZFS version and Python version
      run: |
        id -u -n
        uname -a
        zfs --version
        python3 --version
        ssh -V
        zstd --version
        pv --version | head -n 1
        mbuffer --version |& head -n 1
        command -v sh | xargs ls -l
    - name: Test with unittest
      run: |
        ./test.sh
    - name: Run tests and generate code coverage
      run: |
        ./coverage.sh
        echo "wbackup-zfs-testrun-success"
    - name: Upload code coverage report to workflow run page
      uses: ./.github/workflows/coverage-upload


  test_ubuntu_22_04:
    if: github.event_name == 'schedule' || github.event.inputs.run_all_jobs == 'true' || github.event.inputs.name == 'test_ubuntu_22_04'
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        python-version: ["3.10"]
    timeout-minutes: 80
    steps:
    - uses: actions/checkout@v4
    - name: Run common preparation steps
      uses: ./.github/workflows/common
      with:
        python-version: ${{ matrix.python-version }}
    - name: Display ZFS version and Python version
      run: | 
        id -u -n
        uname -a
        zfs --version
        python3 --version
        ssh -V
        zstd --version
        pv --version | head -n 1
        mbuffer --version |& head -n 1
        command -v sh | xargs ls -l
    - name: Test with unittest
      run: |
        ./test.sh

        echo "Now running tests as root user"
        sudo mkdir -p /root/.ssh
        sudo cp -a $HOME/.ssh/id_rsa $HOME/.ssh/id_rsa.pub /root/.ssh/
        cat $HOME/.ssh/id_rsa.pub | sudo tee -a /root/.ssh/authorized_keys > /dev/null
        sudo ./test.sh
    - name: Run tests and generate code coverage
      run: |
        ./coverage.sh
        echo "wbackup-zfs-testrun-success"
    - name: Upload code coverage report to workflow run page
      uses: ./.github/workflows/coverage-upload


  test_ubuntu_20_04:
    if: github.event_name == 'schedule' || github.event.inputs.run_all_jobs == 'true' || github.event.inputs.name == 'test_ubuntu_20_04'
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        python-version: ["3.8", "3.7"]
    timeout-minutes: 80
    steps:
    - uses: actions/checkout@v4
    - name: Run common preparation steps
      uses: ./.github/workflows/common
      with:
        python-version: ${{ matrix.python-version }}
    - name: Display ZFS version and Python version
      run: | 
        id -u -n
        uname -a
        zfs --version
        python3 --version
        ssh -V
        zstd --version
        pv --version | head -n 1
        mbuffer --version |& head -n 1
        command -v sh | xargs ls -l
    - name: Test with unittest
      run: |
        ./test.sh
    - name: Run tests and generate code coverage
      run: |
        ./coverage.sh
        echo "wbackup-zfs-testrun-success"
    - name: Upload code coverage report to workflow run page
      uses: ./.github/workflows/coverage-upload


  test_freebsd_14_1:
    if: github.event_name == 'schedule' || github.event.inputs.run_all_jobs == 'true' || github.event.inputs.name == 'test_freebsd_14_1'
    runs-on: ubuntu-latest
    timeout-minutes: 80
    steps:
    - uses: actions/checkout@v4
    - name: Test with unittest
      id: test
      uses: vmactions/freebsd-vm@v1  # see https://github.com/vmactions/freebsd-vm
      with:
        release: "14.1"
        run: |
          ./.github-workflow-scripts/test_freebsd_14_1.sh
    - name: Upload code coverage report to workflow run page
      uses: ./.github/workflows/coverage-upload


  test_freebsd_13_3:
    if: github.event_name == 'schedule' || github.event.inputs.run_all_jobs == 'true' || github.event.inputs.name == 'test_freebsd_13_3'
    runs-on: ubuntu-latest
    timeout-minutes: 80
    steps:
    - uses: actions/checkout@v4
    - name: Test with unittest
      id: test
      uses: vmactions/freebsd-vm@v1  # see https://github.com/vmactions/freebsd-vm
      with:
        release: "13.3"
        run: |
          ./.github-workflow-scripts/test_freebsd_13_3.sh
    - name: Upload code coverage report to workflow run page
      uses: ./.github/workflows/coverage-upload


  test_solaris_11_4:
    if: github.event_name == 'schedule' || github.event.inputs.run_all_jobs == 'true' || github.event.inputs.name == 'test_solaris_11_4'
#    if: false  # job currently disabled
    runs-on: ubuntu-latest
    timeout-minutes: 80
    steps:
    - uses: actions/checkout@v4
    - name: Test with unittest
      id: test
      uses: vmactions/solaris-vm@v1  # see https://github.com/vmactions/solaris-vm
      with:
        release: "11.4"
        run: |          
          ./.github-workflow-scripts/test_solaris_14_1.sh
    - name: Upload code coverage report to workflow run page
      uses: ./.github/workflows/coverage-upload

  combine_coverage_reports:
    runs-on: ubuntu-24.04
    needs:
      - test_ubuntu_24_04
      - test_ubuntu_24_04_zfs_latest
      - test_ubuntu_22_04
      - test_ubuntu_20_04
      - test_freebsd_14_1
      - test_freebsd_13_3
      - test_solaris_11_4
    steps:
      - uses: actions/checkout@v4
      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-test_ubuntu_24_04
          path: coverage-test_ubuntu_24_04
      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-test_ubuntu_24_04_zfs_latest
          path: coverage-test_ubuntu_24_04_zfs_latest
      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-test_ubuntu_22_04
          path: coverage-test_ubuntu_22_04
      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-test_ubuntu_20_04
          path: coverage-test_ubuntu_20_04
      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-test_freebsd_14_1
          path: coverage-test_freebsd_14_1
      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-test_freebsd_13_3
          path: coverage-test_freebsd_13_3
      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-test_solaris_11_4
          path: coverage-test_solaris_11_4
      - name: Run common preparation steps
        uses: ./.github/workflows/common
        with:
          python-version: "3.12"
      - name: Merge coverage reports
        run: |
          coverage combine $(find . -name '.coverage*')
          coverage report | tee coverage_report.txt
          coverage html
          coverage xml
      - name: Generate coverage badge
        run: |
          pip install genbadge[coverage]  # see https://smarie.github.io/python-genbadge/
          genbadge coverage -v -i coverage.xml -o htmlcov/coverage-badge.svg
      - name: Upload coverage report to workflow run page
        uses: ./.github/workflows/coverage-upload


  upload_combined_coverage_report_to_github_pages:
    runs-on: ubuntu-24.04
    needs:
      - combine_coverage_reports

    # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
    permissions:
      pages: write      # to deploy to Pages
      id-token: write   # to verify the deployment originates from an appropriate source

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download combined coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-combine_coverage_reports
          path: coverage-combine_coverage_reports
      - name: Setup Pages
        uses: actions/configure-pages@v5  # https://github.com/actions/configure-pages
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3  # see https://github.com/actions/upload-pages-artifact
        with:
          path: coverage-combine_coverage_reports/htmlcov
      - name: Upload combined coverage report to workflow to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4  # see https://github.com/actions/deploy-pages
      - name: "Display URL of GitHub Pages combined coverage report - https://whoschek.github.io/wbackup-zfs/"
        run: |
          echo "Uploaded combined coverage report to GitHub Pages at https://whoschek.github.io/wbackup-zfs/"
